{% extends "detector/base.html" %}
{% block title %}検知結果{% endblock %}

{% block detector_head %}
<style>
  .image-canvas-wrapper {
    position: relative;
    display: inline-block;
    max-width: 100%;
  }
  .image-canvas-wrapper img {
    display: block;
    max-width: 100%;
    height: auto;
  }
  .overlay-canvas {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
  }
  .legend-badge {
    display: inline-block;
    padding: 2px 6px;
    font-size: 12px;
    border-radius: 4px;
    background: rgba(255,0,0,0.85);
    color: #fff;
  }
</style>
{% endblock %}

{% block detector_content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="card mb-3">
        <div class="card-header">
          <h4><i class="bi bi-eye"></i> 検知結果</h4>
        </div>
        <div class="card-body">
          {% if detection_count is not none %}
          <div class="mb-3">
            <span class="badge bg-success">
              <i class="bi bi-bounding-box"></i> 検出 {{ detection_count }} 件
            </span>
            {% if detected_at %}
            <small class="text-muted ms-2">最終検知: {{ detected_at }}</small>
            {% endif %}
          </div>
          {% endif %}
          <div class="text-center mb-3">
            <div class="image-canvas-wrapper">
              <img id="detectedImage" src="{{ url_for('detector.uploaded_file', filename=user_image.filename) }}" alt="{{ user_image.original_filename or user_image.filename }}" class="img-fluid rounded">
              <canvas id="overlayCanvas" class="overlay-canvas"></canvas>
            </div>
            <div class="form-check form-switch mt-2 d-inline-flex align-items-center gap-2">
              <input class="form-check-input" type="checkbox" id="toggleOverlay" checked>
              <label class="form-check-label" for="toggleOverlay">検出枠を表示</label>
            </div>
          </div>
          <h6 class="mb-3">検出オブジェクト</h6>
          {% if results %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>#</th>
                  <th>クラス</th>
                  <th>信頼度</th>
                  <th>領域 (x, y, w, h)</th>
                </tr>
              </thead>
              <tbody>
                {% for r in results %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ r.class }}</td>
                  <td>{{ '%.2f'|format(r.confidence) }}</td>
                  <td>{{ r.bbox.x }}, {{ r.bbox.y }}, {{ r.bbox.width }}, {{ r.bbox.height }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted">検出結果はありません。</p>
          {% endif %}
          <div class="mt-3 d-flex gap-2">
            <a href="{{ url_for('detector.upload') }}" class="btn btn-primary"><i class="bi bi-upload"></i> 別の画像をアップロード</a>
            <a href="{{ url_for('detector.gallery') }}" class="btn btn-outline-secondary"><i class="bi bi-images"></i> ギャラリー</a>
            <form method="post" class="ms-auto">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
              <button type="submit" class="btn btn-outline-warning"><i class="bi bi-arrow-clockwise"></i> 再検知</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block detector_extra_js %}
<script id="detection-data" type="application/json">{{ results|tojson }}</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const img = document.getElementById('detectedImage');
    const canvas = document.getElementById('overlayCanvas');
    const toggle = document.getElementById('toggleOverlay');
    if (!img || !canvas || !toggle) return;

    const ctx = canvas.getContext('2d');
    const dataEl = document.getElementById('detection-data');
    let results = [];
    try {
      results = dataEl ? JSON.parse(dataEl.textContent || '[]') : [];
    } catch (e) {
      console.warn('Failed to parse detection data', e);
      results = [];
    }

    function sizeCanvasToImage() {
      // Match canvas size to the currently rendered image size
      const width = Math.round(img.clientWidth);
      const height = Math.round(img.clientHeight);
      canvas.width = width;
      canvas.height = height;
      canvas.style.width = width + 'px';
      canvas.style.height = height + 'px';
    }

    function drawDetections() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (!toggle.checked || !Array.isArray(results) || results.length === 0) return;

      const nw = img.naturalWidth || img.clientWidth || 1;
      const nh = img.naturalHeight || img.clientHeight || 1;
      const sx = (img.clientWidth || nw) / nw;
      const sy = (img.clientHeight || nh) / nh;

      results.forEach(r => {
        const x = Math.round((r.bbox?.x || 0) * sx);
        const y = Math.round((r.bbox?.y || 0) * sy);
        const w = Math.round((r.bbox?.width || 0) * sx);
        const h = Math.round((r.bbox?.height || 0) * sy);

        // Box
        ctx.strokeStyle = 'rgba(255, 0, 0, 0.9)';
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, w, h);

        // Label background
        const label = `${r.class || 'object'} (${Math.round((r.confidence || 0) * 100)}%)`;
        ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif';
        const metrics = ctx.measureText(label);
        const textWidth = Math.ceil(metrics.width);
        const labelX = Math.max(0, Math.min(x, canvas.width - textWidth - 6));
        const labelY = Math.max(12, y - 4);
        ctx.fillStyle = 'rgba(255, 0, 0, 0.9)';
        ctx.fillRect(labelX, labelY - 12, textWidth + 6, 14);
        ctx.fillStyle = '#fff';
        ctx.fillText(label, labelX + 3, labelY - 2);
      });
    }

    function refresh() {
      sizeCanvasToImage();
      drawDetections();
    }

    if (img.complete) {
      // Image already loaded from cache
      refresh();
    } else {
      img.addEventListener('load', refresh, { once: true });
    }
    window.addEventListener('resize', refresh);
    toggle.addEventListener('change', drawDetections);
  });
</script>
{% endblock %}
