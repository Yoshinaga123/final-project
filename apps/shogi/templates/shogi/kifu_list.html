{% extends "base.html" %}
{% block title %}棋譜一覧 - 将棋{% endblock %}

{% block head %}
<style>
    /* テーブルのダークモード対応 - より白い文字 */
    body.theme-dark .table {
        color: #ffffff !important;
    }

    body.theme-dark .table td {
        color: #ffffff !important;
    }

    body.theme-dark .table th {
        color: #ffffff !important;
    }

    body.theme-dark .table-striped > tbody > tr:nth-of-type(odd) > td {
        background-color: rgba(255, 255, 255, 0.05) !important;
        color: #ffffff !important;
    }

    /* 常時黒背景: ホバー時も色変更しない */
    body.theme-dark .table-hover > tbody > tr:hover > td {
        background-color: #121518 !important;
        color: #ffffff !important;
    }

    /* 全行を同じ濃い背景に統一 */
    body.theme-dark .kifu-table tbody tr td {
        background-color: #121518 !important;
    }
    body.theme-dark .kifu-table.table-striped > tbody > tr:nth-of-type(odd) > td {
        background-color: #121518 !important; /* ストライプを無効化 */
    }
    body.theme-dark .kifu-table tbody tr td { border-top-color: #1f252b !important; }

    body.theme-dark .table-dark {
        background-color: var(--theme-bg-secondary) !important;
        border-color: var(--theme-border) !important;
    }

    body.theme-dark .table-dark th {
        background-color: var(--theme-bg-primary) !important;
        color: #ffffff !important;
        border-color: var(--theme-border) !important;
    }

    /* ファイル名の文字をより明るく */
    body.theme-dark .table td:first-child {
        color: #ffffff !important;
        font-weight: 500;
    }

    /* バッジのダークモード対応 */
    body.theme-dark .bg-info {
        background-color: var(--bs-info) !important;
        color: #ffffff !important;
    }

    body.theme-dark .badge {
        color: #ffffff !important;
        font-weight: 600;
    }

    /* アイコンのダークモード対応 */
    body.theme-dark .text-primary {
        color: #79c0ff !important;
    }

    /* すべてのテーブル内テキストを白く */
    body.theme-dark table,
    body.theme-dark table td,
    body.theme-dark table th,
    body.theme-dark table span,
    body.theme-dark table .badge {
        color: #ffffff !important;
    }

    /* 日時表示もより明るく */
    body.theme-dark .table td:nth-child(4) {
        color: #f0f0f0 !important;
    }

    /* サイズ表示もより明るく */
    body.theme-dark .table td:nth-child(3) {
        color: #f0f0f0 !important;
    }
</style>
{% endblock %}

{% block body %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-list"></i> 棋譜一覧</h2>
                <div>
                    <a href="{{ url_for('shogi.new') }}" class="btn btn-primary">
                        <i class="fas fa-upload"></i> アップロード
                    </a>
                </div>
            </div>

            {% if kifu_files %}
                <div class="table-responsive">
                    <table class="table table-hover kifu-table">
                        <thead class="table-dark">
                            <tr>
                                <th>ファイル名</th>
                                <th>形式</th>
                                <th>サイズ</th>
                                <th>更新日時</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in kifu_files %}
                            <tr>
                                <td>
                                    <i class="fas fa-file-alt text-primary"></i>
                                    {{ file.filename }}
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ file.format }}</span>
                                </td>
                                <td>{{ "%.1f"|format(file.size / 1024) }} KB</td>
                                <td>{{ file.modified }}</td>
                                <td>
                                    <a href="{{ file.url }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i> 表示・再生
                                    </a>
                                    <button class="btn btn-sm btn-outline-secondary download-kifu-btn" data-filename="{{ file.filename }}">
                                        <i class="fas fa-download"></i> ダウンロード
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">棋譜ファイルがありません</h4>
                    <p class="text-muted">新しい棋譜を作成するか、ファイルをアップロードしてください。</p>
                    <a href="{{ url_for('shogi.new') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> 新規棋譜作成
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log("=== KIFU LIST DEBUG - Template loaded ===");
console.log("Base URL:", window.location.origin);
console.log("Static URL path should be:", window.location.origin + "/static/js/kifu-view.js");

// シンプルなテストファイルの読み込み
console.log("Loading test file...");
</script>
<script src="{{ url_for('static', filename='js/test-simple.js') }}"></script>
<script>
console.log("After test script load");
console.log("testDownload available:", typeof testDownload);

// APIからファイルを取得してダウンロード
function downloadKifuFromAPI(filename) {
    console.log("=== API DOWNLOAD DEBUG ===");
    console.log("Function called with filename:", filename);
    
    fetch(`/shogi/api/kifu/${filename}`)
        .then(response => {
            console.log("API response status:", response.status);
            return response.json();
        })
        .then(data => {
            console.log("API data received:", !!data);
            
            if (data.success && data.content) {
                console.log("Creating download...");
                const blob = new Blob([data.content], { type: 'text/plain;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                console.log("Download completed");
            } else {
                console.error("API error:", data.error || "Unknown error");
                alert('ファイルのダウンロードに失敗しました: ' + (data.error || "不明なエラー"));
            }
        })
        .catch(error => {
            console.error('API fetch error:', error);
            alert('ファイルのダウンロードに失敗しました: ' + error.message);
        });
}

// DOM読み込み完了時の処理
document.addEventListener('DOMContentLoaded', function() {
    console.log("=== KIFU LIST DIRECT DEBUG - DOM Content Loaded ===");
    
    // ダウンロードボタンにイベント設定
    const downloadButtons = document.querySelectorAll('.download-kifu-btn');
    console.log("Download buttons found:", downloadButtons.length);
    
    downloadButtons.forEach(function(btn, index) {
        const filename = btn.dataset.filename;
        console.log(`Setting up button ${index + 1}: ${filename}`);
        
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log("Download button clicked:", filename);
            downloadKifuFromAPI(filename);
        });
    });
});
</script>
{% endblock %}
