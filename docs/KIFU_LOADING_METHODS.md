# 棋譜読み込み方法の完全ガイド

このドキュメントでは、KifuForJSを使用した様々な棋譜読み込み方法について説明します。

## 目次

1. [基本的な読み込み方法](#基本的な読み込み方法)
2. [高度な読み込み方法](#高度な読み込み方法)
3. [ユーティリティ関数](#ユーティリティ関数)
4. [実装例](#実装例)
5. [ベストプラクティス](#ベストプラクティス)

## 基本的な読み込み方法

### 1. タグ方式

最も基本的な方法で、HTMLの`<script type="text/kifu">`タグの中に棋譜を直接記述します。

```html
<script type="text/kifu">
後手の持駒：飛二　金四　桂四　香四　歩十八
９ ８ ７ ６ ５ ４ ３ ２ １
+---------------------------+
|v香v桂v銀v金v王v金v銀v桂v香|一
| ・v飛 ・ ・ ・ ・ ・v角 ・|二
|v歩v歩v歩v歩v歩v歩v歩v歩v歩|三
| ・ ・ ・ ・ ・ ・ ・ ・ ・|四
| ・ ・ ・ ・ ・ ・ ・ ・ ・|五
| ・ ・ ・ ・ ・ ・ ・ ・ ・|六
| 歩 歩 歩 歩 歩 歩 歩 歩 歩|七
| ・ 角 ・ ・ ・ ・ ・ 飛 ・|八
| 香 桂 銀 金 玉 金 銀 桂 香|九
+---------------------------+
先手の持駒：なし
手合割：平手
先手：吉永
後手：島田
手数----指手---------消費時間--
   1 ７六歩(77)        ( 0:01/00:00:01)
   2 ３四歩(33)        ( 0:01/00:00:01)
   3 ６六歩(67)        ( 0:04/00:00:05)
   4 ９四歩(93)        ( 0:01/00:00:02)
   5 ９六歩(97)        ( 0:01/00:00:06)
</script>
```

**特徴:**
- 最もシンプルで直感的
- 静的な棋譜に適している
- インデントの自動処理に対応

### 2. data-kifu属性方式

改行が含まれない短い棋譜の場合、`data-kifu`属性を使用できます。

```html
<script type="text/kifu" data-kifu="▲７六歩 △３四歩 ▲６六歩 △９四歩 ▲９六歩"></script>
```

**特徴:**
- 短い棋譜に適している
- HTML属性として記述可能
- 改行を含まない場合のみ使用可能

### 3. インデント自動処理

タグの中身にインデントが含まれていても、KifuForJSが自動的に処理します。

```html
<script type="text/kifu">
  # KIF形式棋譜ファイル
  # Generated by Shogidokoro
  後手の持駒：飛　金三　銀三　桂二　香四　歩十三
  ９ ８ ７ ６ ５ ４ ３ ２ １
  +---------------------------+
  | ・ ・ ・ ・ 馬 ・ ・v桂 ・|一
  | ・ ・ ・ ・ ・ ・ ・v玉 ・|二
  | ・ ・ ・ ・ ・ ・v歩v歩 ・|三
  | ・ ・ ・ ・ ・ ・ ・v金v歩|四
  | ・ ・ ・ ・ 歩 ・ ・ ・ 歩|五
  | ・ ・ ・ ・ ・ ・ ・ ・ ・|六
  | ・ ・ ・ ・ ・ ・ ・ ・ ・|七
  | ・ ・ ・ ・ ・ ・ ・ ・ ・|八
  | ・ ・ ・ ・ ・ ・ ・ ・ ・|九
  +---------------------------+
  先手の持駒：飛　角　銀　桂
  先手：
  後手：
  手数----指手---------消費時間--
  1 ５二飛打      (00:31 / 00:00:31)
  2 ３二金打      (00:00 / 00:00:00)
  3 ３一角打      (00:00 / 00:00:31)
  4 同　玉(22)    (00:00 / 00:00:00)
</script>
```

**特徴:**
- コードの可読性を保ちながら記述可能
- 自動的にインデントを除去
- 複数行にわたる棋譜に適している

## 高度な読み込み方法

### 4. JavaScript関数方式

プログラムで動的に棋譜を読み込む方法です。

```javascript
// 棋譜文字列から読み込み
function loadKifuFromString(kifuString, targetElementId) {
    const targetElement = document.getElementById(targetElementId);
    if (targetElement) {
        const kifu = new KifuForJS(targetElement);
        kifu.load(kifuString);
    }
}

// ファイルから読み込み
async function loadKifuFromFile(filePath, targetElementId) {
    try {
        const response = await fetch(filePath);
        const kifuString = await response.text();
        loadKifuFromString(kifuString, targetElementId);
    } catch (error) {
        console.error('棋譜ファイルの読み込みに失敗しました:', error);
    }
}

// URLから読み込み
async function loadKifuFromUrl(url, targetElementId) {
    try {
        const response = await fetch(url);
        const kifuString = await response.text();
        loadKifuFromString(kifuString, targetElementId);
    } catch (error) {
        console.error('棋譜URLの読み込みに失敗しました:', error);
    }
}
```

**特徴:**
- 動的な棋譜読み込みが可能
- エラーハンドリングが可能
- 非同期処理に対応

### 5. 棋譜マネージャー方式

複数の棋譜ボードを管理する方法です。

```javascript
class KifuManager {
    constructor() {
        this.boards = new Map();
        this.currentBoard = null;
    }
    
    // 新しい棋譜ボードを作成
    createBoard(elementId, kifuString = null) {
        const element = document.getElementById(elementId);
        if (!element) {
            console.error(`要素 ${elementId} が見つかりません`);
            return null;
        }
        
        const board = new KifuForJS(element);
        this.boards.set(elementId, board);
        
        if (kifuString) {
            board.load(kifuString);
        }
        
        return board;
    }
    
    // 既存のボードに棋譜を読み込み
    loadKifu(elementId, kifuString) {
        const board = this.boards.get(elementId);
        if (board) {
            board.load(kifuString);
        } else {
            console.error(`ボード ${elementId} が見つかりません`);
        }
    }
}
```

**特徴:**
- 複数の棋譜ボードを同時に管理
- ボードの作成・削除・切り替えが可能
- 大規模なアプリケーションに適している

### 6. Reactコンポーネント方式

Reactアプリケーションで使用する方法です。

```jsx
import React, { useRef, useEffect } from 'react';

const KifuComponent = ({ kifuString, options = {} }) => {
    const boardRef = useRef(null);
    
    useEffect(() => {
        if (boardRef.current && kifuString) {
            const kifu = new KifuForJS(boardRef.current, options);
            kifu.load(kifuString);
        }
    }, [kifuString, options]);
    
    return <div ref={boardRef}></div>;
};

// 使用例
<KifuComponent 
    kifuString={kifuData} 
    options={{ 
        theme: 'default',
        responsive: true 
    }} 
/>
```

**特徴:**
- Reactアプリケーションに統合可能
- プロパティの変更に自動対応
- 再利用可能なコンポーネント

## ユーティリティ関数

### KifuUtils クラス

棋譜の読み込みと処理を行うユーティリティ関数を提供します。

```javascript
// 棋譜文字列から読み込み
KifuUtils.loadFromString(kifuString, targetElementId, options);

// ファイルから読み込み
KifuUtils.loadFromFile(filePath, targetElementId, options);

// URLから読み込み
KifuUtils.loadFromUrl(url, targetElementId, options);

// インデントを自動処理
const processedKifu = KifuUtils.processIndentation(kifuString);

// 棋譜を検証
const validation = KifuUtils.validateKifu(kifuString);

// 棋譜を正規化
const normalizedKifu = KifuUtils.normalizeKifu(kifuString);

// 棋譜の基本情報を抽出
const info = KifuUtils.extractKifuInfo(kifuString);
```

### KifuFormatter クラス

棋譜の表示形式を変更する関数を提供します。

```javascript
// 簡潔な形式に変換
const compact = KifuFormatter.toCompact(kifuString);

// 詳細な形式に変換
const detailed = KifuFormatter.toDetailed(kifuString);

// HTML形式に変換
const html = KifuFormatter.toHTML(kifuString);
```

## 実装例

### 基本的な使用例

```html
<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/kifu-for-js@5/bundle/kifu-for-js.min.js"></script>
    <script src="kifu-utils.js"></script>
</head>
<body>
    <div id="board-1"></div>
    
    <script type="text/kifu">
    # 棋譜データ
    後手の持駒：飛二　金四　桂四　香四　歩十八
    ９ ８ ７ ６ ５ ４ ３ ２ １
    +---------------------------+
    |v香v桂v銀v金v王v金v銀v桂v香|一
    | ・v飛 ・ ・ ・ ・ ・v角 ・|二
    |v歩v歩v歩v歩v歩v歩v歩v歩v歩|三
    | ・ ・ ・ ・ ・ ・ ・ ・ ・|四
    | ・ ・ ・ ・ ・ ・ ・ ・ ・|五
    | ・ ・ ・ ・ ・ ・ ・ ・ ・|六
    | 歩 歩 歩 歩 歩 歩 歩 歩 歩|七
    | ・ 角 ・ ・ ・ ・ ・ 飛 ・|八
    | 香 桂 銀 金 玉 金 銀 桂 香|九
    +---------------------------+
    先手の持駒：なし
    手合割：平手
    先手：吉永
    後手：島田
    手数----指手---------消費時間--
       1 ７六歩(77)        ( 0:01/00:00:01)
       2 ３四歩(33)        ( 0:01/00:00:01)
       3 ６六歩(67)        ( 0:04/00:00:05)
    </script>
</body>
</html>
```

### 動的な読み込み例

```html
<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/kifu-for-js@5/bundle/kifu-for-js.min.js"></script>
    <script src="kifu-utils.js"></script>
</head>
<body>
    <div id="board-1"></div>
    <button onclick="loadKifu()">棋譜を読み込み</button>
    
    <script>
    function loadKifu() {
        const kifuString = `後手の持駒：飛二　金四　桂四　香四　歩十八
９ ８ ７ ６ ５ ４ ３ ２ １
+---------------------------+
|v香v桂v銀v金v王v金v銀v桂v香|一
| ・v飛 ・ ・ ・ ・ ・v角 ・|二
|v歩v歩v歩v歩v歩v歩v歩v歩v歩|三
| ・ ・ ・ ・ ・ ・ ・ ・ ・|四
| ・ ・ ・ ・ ・ ・ ・ ・ ・|五
| ・ ・ ・ ・ ・ ・ ・ ・ ・|六
| 歩 歩 歩 歩 歩 歩 歩 歩 歩|七
| ・ 角 ・ ・ ・ ・ ・ 飛 ・|八
| 香 桂 銀 金 玉 金 銀 桂 香|九
+---------------------------+
先手の持駒：なし
手合割：平手
先手：吉永
後手：島田
手数----指手---------消費時間--
   1 ７六歩(77)        ( 0:01/00:00:01)
   2 ３四歩(33)        ( 0:01/00:00:01)
   3 ６六歩(67)        ( 0:04/00:00:05)`;
        
        KifuUtils.loadFromString(kifuString, 'board-1');
    }
    </script>
</body>
</html>
```

## ベストプラクティス

### 1. 適切な方法の選択

- **静的な棋譜**: タグ方式を使用
- **動的な棋譜**: JavaScript関数方式を使用
- **複数の棋譜**: 棋譜マネージャー方式を使用
- **Reactアプリ**: Reactコンポーネント方式を使用

### 2. エラーハンドリング

```javascript
try {
    const kifu = KifuUtils.loadFromString(kifuString, 'board-1');
    if (!kifu) {
        console.error('棋譜の読み込みに失敗しました');
    }
} catch (error) {
    console.error('エラーが発生しました:', error);
}
```

### 3. パフォーマンスの最適化

```javascript
// 大きな棋譜の場合は遅延読み込みを使用
async function loadLargeKifu(filePath, targetElementId) {
    const response = await fetch(filePath);
    const kifuString = await response.text();
    
    // バックグラウンドで処理
    setTimeout(() => {
        KifuUtils.loadFromString(kifuString, targetElementId);
    }, 0);
}
```

### 4. メモリ管理

```javascript
// 不要になったボードは削除
kifuManager.removeBoard('board-1');

// 大量の棋譜を扱う場合は定期的にクリーンアップ
setInterval(() => {
    kifuManager.cleanup();
}, 60000); // 1分ごと
```

### 5. アクセシビリティ

```html
<div id="board-1" 
     role="img" 
     aria-label="将棋盤" 
     aria-describedby="kifu-description">
</div>
<div id="kifu-description">
    吉永島田戦の棋譜です。先手：吉永、後手：島田。
</div>
```

## まとめ

このドキュメントでは、KifuForJSを使用した様々な棋譜読み込み方法について説明しました。プロジェクトの要件に応じて適切な方法を選択し、エラーハンドリングとパフォーマンスの最適化を心がけてください。

詳細な実装例については、`/shogi/kifu-examples`ページを参照してください。
